<Window x:Class="Squiggle.UI.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:chat="clr-namespace:Squiggle.Chat;assembly=Squiggle.Chat"
    xmlns:controls="clr-namespace:Squiggle.UI.Controls"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"        
    xmlns:tray="clr-namespace:Hardcodet.Wpf.TaskbarNotification"
    xmlns:local="clr-namespace:Squiggle.UI"
    Title="Squiggle Messenger" 
    Height="{local:SettingBinding MainWindowHeight}"
    Width="{local:SettingBinding MainWindowWidth}"
    Left="{local:SettingBinding MainWindowLeft}"
    Top="{local:SettingBinding MainWindowTop}"
    Icon="/Squiggle;component/Images/Chat.ico" Loaded="Window_Loaded" Closed="Window_Closed" Closing="Window_Closing">
    <Window.Resources>
        <local:StatusConverter x:Key="statusConverter" />
        <local:TrayIconConverter x:Key="trayIconConverter" />
        <ObjectDataProvider MethodName="GetChangableStatuses" 
            ObjectType="{x:Type local:SquiggleUtility}" 
            x:Key="AvailableUserStatus">
        </ObjectDataProvider>
        <Style x:Key="signedInMenu" TargetType="{x:Type MenuItem}">
            <Style.Setters>
                <Setter Property="IsEnabled" Value="{Binding IsLoggedIn}" />
            </Style.Setters>
        </Style>
        <Style x:Key="statusMenu" TargetType="{x:Type MenuItem}" BasedOn="{StaticResource signedInMenu}">
            <Style.Setters>
                <Setter Property="ItemsSource" Value="{Binding Source={StaticResource AvailableUserStatus}}" />
                <Setter Property="ItemTemplate">
                    <Setter.Value>
                        <DataTemplate>
                            <ContentPresenter Content="{Binding Converter={StaticResource statusConverter}}" />
                        </DataTemplate>
                    </Setter.Value>
                </Setter>
            </Style.Setters>
        </Style>
    </Window.Resources>
    <Window.CommandBindings>
        <CommandBinding Command="local:MainWindow.SendInstantMessageToContacts" Executed="SendInstantMessage_Executed" CanExecute="SendInstantMessage_CanExecute" />
        <CommandBinding Command="local:MainWindow.SendFileToContacts" Executed="SendFile_Executed" CanExecute="SendFile_CanExecute" />
    </Window.CommandBindings>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition />
        </Grid.RowDefinitions>
        <tray:TaskbarIcon IconSource="{Binding LoggedInUser.Status, Converter={StaticResource trayIconConverter}, FallbackValue=Online}" 
                          TrayLeftMouseDown="trayIcon_TrayLeftMouseDown" x:Name="trayIcon">
            <tray:TaskbarIcon.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Open" Click="OpenMenu_Click" />
                    <MenuItem Header="Change Status"
                              MenuItem.Click="StatusMenu_Click"
                              Style="{StaticResource statusMenu}" />
                    <MenuItem Header="Sign Out" 
                              Click="SignOutMenu_Click" 
                              Style="{StaticResource signedInMenu}" />
                    <MenuItem Header="Quit" Click="QuiteMenu_Click" />
                </ContextMenu>
            </tray:TaskbarIcon.ContextMenu>
        </tray:TaskbarIcon>
        <Menu Grid.Row="0">
            <MenuItem Header="_File">
                <MenuItem Header="Sig_n Out" 
                          Click="SignOutMenu_Click" 
                          Style="{StaticResource signedInMenu}" />
                <Separator />
                <MenuItem Header="S_tatus" 
                          Style="{StaticResource statusMenu}"
                          MenuItem.Click="StatusMenu_Click" />
                <Separator />
                <MenuItem Header="_Open received files folder" MenuItem.Click="OpenReceivedFilesMenu_Click" />
                <Separator />
                <MenuItem Header="_Close" MenuItem.Click="CloseMenu_Click" />
            </MenuItem>
            <MenuItem Header="_Actions">
                <MenuItem Header="_Send an instant message" Command="local:MainWindow.SendInstantMessageToContacts"/>
                <MenuItem Header="Send a _file" Command="local:MainWindow.SendFileToContacts" />
            </MenuItem>
            <MenuItem Header="_Tools">
                <MenuItem Header="_Settings..." MenuItem.Click="SettingsMenu_Click" />
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About Squiggle" MenuItem.Click="AboutMenu_Click" />
            </MenuItem>
        </Menu>        
        <controls:ChatClientControl Grid.Row="1" Width="Auto" Height="Auto" x:Name="chatControl" />
    </Grid>
</Window>
